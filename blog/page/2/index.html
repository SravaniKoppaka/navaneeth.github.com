
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>{love to code}</title>
	<meta name="author" content="nkn">

	
	<meta name="description" content="Working With Native Code Easily in C# With the Help of C++/CLI .NET comes with pretty good interoperability options which would enable unmanaged &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="{love to code}" type="application/atom+xml">
	
	<link rel="canonical" href="http://navaneeth.github.io/blog/page/2/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	Included file 'custom/head.html' not found in _includes directory
</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><nav id="main-nav"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul></nav>
<!-- <nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/navaneethkn" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/navaneeth" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav> -->
<div class="profile-container">
  <div class="profilepic">
    <script src="/javascripts/md5.js"></script>
    <script type="text/javascript">
$(function(){
  $('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("navaneethkn@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
});
    </script>
  </div>
  <hgroup>
  <h1 class="site-title"><a href="/">{love to code}</a></h1>
  
  <p class="site-subtitle">Random thoughts on programming and travel.</p>
  
  </hgroup>
  
</div>
</header>
			</div>
		</div>
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="article-inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name"><a href="/blog/2013/02/17/working-with-native-code-in-csharp-easily-with-cplusplus-cli/" itemprop="url">Working With Native Code Easily in C# With the Help of C++/CLI</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>.NET comes with pretty good interoperability options which would enable unmanaged code to be used from a managed environment. In C#, to call a function which is available in a DLL, <code>PInvoke</code> (Platform invocation service) can be used. Here is what MSDN says.</p>

<blockquote><p>Platform Invocation Services (PInvoke) allows managed code to call unmanaged functions that are implemented in a DLL.</p></blockquote>

<p>This is very helpful when you need to call some system functions from your C# application. Now let us assume that you have lot of code which is written in C or C++. You are writing a brand new application in C# which internally uses the C/C++ code available. Since C/C++ code is categorised as unmanaged code, you can&rsquo;t directly use them in C#. At C# side, wrapper classes and functions has to be written to interop properly with the native code. As I said earlier, if you just need to use a single function, it is easy to do directly from C# using <code>PInvoke</code>. But when you need almost all the functionalities/API to be available as a managed object, <code>PInvoke</code> would be a pain to use. Let us take an example from <a href="http://msdn.microsoft.com/en-us/library/aa288468%28v=vs.71%29.aspx">MSDN</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">tagLOGFONT</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">LONG</span> <span class="n">lfHeight</span><span class="p">;</span>
</span><span class='line'>   <span class="n">LONG</span> <span class="n">lfWidth</span><span class="p">;</span>
</span><span class='line'>   <span class="n">LONG</span> <span class="n">lfEscapement</span><span class="p">;</span>
</span><span class='line'>   <span class="n">LONG</span> <span class="n">lfOrientation</span><span class="p">;</span>
</span><span class='line'>   <span class="n">LONG</span> <span class="n">lfWeight</span><span class="p">;</span>
</span><span class='line'>   <span class="n">BYTE</span> <span class="n">lfItalic</span><span class="p">;</span>
</span><span class='line'>   <span class="n">BYTE</span> <span class="n">lfUnderline</span><span class="p">;</span>
</span><span class='line'>   <span class="n">BYTE</span> <span class="n">lfStrikeOut</span><span class="p">;</span>
</span><span class='line'>   <span class="n">BYTE</span> <span class="n">lfCharSet</span><span class="p">;</span>
</span><span class='line'>   <span class="n">BYTE</span> <span class="n">lfOutPrecision</span><span class="p">;</span>
</span><span class='line'>   <span class="n">BYTE</span> <span class="n">lfClipPrecision</span><span class="p">;</span>
</span><span class='line'>   <span class="n">BYTE</span> <span class="n">lfQuality</span><span class="p">;</span>
</span><span class='line'>   <span class="n">BYTE</span> <span class="n">lfPitchAndFamily</span><span class="p">;</span>
</span><span class='line'>   <span class="n">TCHAR</span> <span class="n">lfFaceName</span><span class="p">[</span><span class="n">LF_FACESIZE</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span> <span class="n">LOGFONT</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In C#, this can be represented as</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// logfont.cs</span>
</span><span class='line'><span class="c1">// compile with: /target:module</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="na">[StructLayout(LayoutKind.Sequential)]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">LOGFONT</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">LF_FACESIZE</span> <span class="p">=</span> <span class="m">32</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">lfHeight</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">lfWidth</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">lfEscapement</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">lfOrientation</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">lfWeight</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfItalic</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfUnderline</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfStrikeOut</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfCharSet</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfOutPrecision</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfClipPrecision</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfQuality</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfPitchAndFamily</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [MarshalAs(UnmanagedType.ByValTStr, SizeConst=LF_FACESIZE)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">lfFaceName</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Look at the C# example. It is not as clean as the structure definition at the C side. It contains attributes which specify the structure alignment, then marshaling etc. When the structure contains references to other structures, things gets complicated.</p>

<p>For C or C++ programmers, it is always convenient to declare the struct as they normally do. That&rsquo;s the beauty of <code>C++/CLI</code> which allows you to combine managed and unmanaged code together and makes interoperability very straightforward.</p>

<p>In this post, we will take <code>SQLite</code> as an example and write a managed class which can be consumed from C#. We will wrap SQLite code using <code>C++/CLI</code> and consume from C#. SQLite has a huge API and we won&rsquo;t be covering all of them. We will cover APIs which will allow to open a DB connection and execute a simple query.</p>

<p>Note: SQLite is chosen as an example. The correct way to wrap SQLite is adhering to ADO.NET standards and providing a API by extending IDBConnection. But for this post, we will ignore this and provide a custom simple API.</p>

<h2>SQLite API</h2>

<p>We will wrap the following functions</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">sqlite3_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">sqlite3</span> <span class="o">**</span><span class="n">ppDb</span><span class="p">);</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">sqlite3_exec</span><span class="p">(</span>
</span><span class='line'>  <span class="n">sqlite3</span><span class="o">*</span><span class="p">,</span>                                  <span class="cm">/* An open database */</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sql</span><span class="p">,</span>                           <span class="cm">/* SQL to be evaluated */</span>
</span><span class='line'>  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="kt">char</span><span class="o">**</span><span class="p">,</span><span class="kt">char</span><span class="o">**</span><span class="p">),</span>  <span class="cm">/* Callback function */</span>
</span><span class='line'>  <span class="kt">void</span> <span class="o">*</span><span class="p">,</span>                                    <span class="cm">/* 1st argument to callback */</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">**</span><span class="n">errmsg</span>                              <span class="cm">/* Error msg written here */</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our managed API will look like,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SQLite</span> <span class="n">db</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SQLite</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span><span class='line'><span class="n">db</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>callback</code> can be assigned to a function which takes 2 parameters of type <code>List&lt;String&gt;</code>. It will contain column names and values respectively.</p>

<h2>Wrapper class in C++/CLI</h2>

<p>We will have a Visual studio solution with 3 projects.</p>

<ul>
<li>Static library which contains SQLite source code. This will be compiled as C and produces a static library.</li>
<li>C++/CLI library project which adds the first project as a reference.</li>
<li>A C# console application for testing. This project will have a reference to the assembly generated by C++/CLI project.</li>
</ul>


<p><img src="/images/posts/20130217/solution_explorer.png" alt="Solution explorer" /></p>

<p>In C++/CLI, we start off by creating the following class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// SQLiteWrapper.h</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma once</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;sqlite3.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">System</span><span class="o">::</span><span class="n">Collections</span><span class="o">::</span><span class="n">Generic</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="n">SQLiteWrapper</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Main class that wraps the native API</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">ref</span> <span class="k">class</span> <span class="nc">SQLite</span> <span class="o">:</span> <span class="n">IDisposable</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span><span class="o">:</span>
</span><span class='line'>        <span class="n">SQLite</span><span class="p">(</span><span class="n">String</span><span class="o">^</span> <span class="n">filePath</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">void</span> <span class="n">Execute</span><span class="p">(</span><span class="n">String</span><span class="o">^</span> <span class="n">sql</span><span class="p">,</span> <span class="n">Action</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^&gt;^</span> <span class="n">callback</span><span class="p">);</span>
</span><span class='line'>        <span class="o">~</span><span class="n">SQLite</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span><span class="o">:</span>
</span><span class='line'>        <span class="n">sqlite3</span><span class="o">*</span> <span class="n">db</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">ref</span> <span class="k">class</span> <span class="nc">SQLiteError</span> <span class="o">:</span> <span class="n">Exception</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span><span class="o">:</span>
</span><span class='line'>        <span class="n">SQLiteError</span><span class="p">(</span><span class="n">String</span><span class="o">^</span> <span class="n">errorMessage</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">ref</span> <span class="k">class</span> <span class="nc">SQLiteDataCarrier</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span><span class="o">:</span>
</span><span class='line'>        <span class="n">SQLiteDataCarrier</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnNames</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnValues</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">this</span><span class="o">-&gt;</span><span class="n">columnNames</span> <span class="o">=</span> <span class="n">columnNames</span><span class="p">;</span>
</span><span class='line'>            <span class="k">this</span><span class="o">-&gt;</span><span class="n">columnValues</span> <span class="o">=</span> <span class="n">columnValues</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">property</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">ColumnNames</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">get</span><span class="p">()</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">columnNames</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">property</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">ColumnValues</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">get</span><span class="p">()</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">columnValues</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span><span class="o">:</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnNames</span><span class="p">;</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnValues</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class holds an instance to <code>sqlite3</code> structure which is the core of SQLite library. Even though the class is a managed class, C++/CLI allows you to hold a pointer which points to <code>sqlite3</code>.</p>

<p>Our constructor can be implemented like,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Constructor for managed class SQLite</span>
</span><span class='line'><span class="n">SQLite</span><span class="o">::</span><span class="n">SQLite</span><span class="p">(</span><span class="n">String</span><span class="o">^</span> <span class="n">filePath</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">IntPtr</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Marshal</span><span class="o">::</span><span class="n">StringToHGlobalAnsi</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_filePath</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">ToPointer</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">sqlite3</span><span class="o">*</span> <span class="n">d</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">sqlite3_open</span><span class="p">(</span><span class="n">_filePath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">gcnew</span> <span class="n">SQLiteError</span><span class="p">(</span><span class="s">&quot;Unable to open database&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Holding the DB pointer as a field</span>
</span><span class='line'>        <span class="c1">// This is a pointer to native struct, but it can be stored in managed class!</span>
</span><span class='line'>        <span class="n">db</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">finally</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Marshal</span><span class="o">::</span><span class="n">FreeHGlobal</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code shows how well C++/CLI allows you to mix types from both managed and unmanaged world. It is beautiful!</p>

<p>All this constructor does is to initialize <code>sqlite3</code> instance and update the <code>db</code> pointer with correct reference.</p>

<p>Here is how <code>Execute()</code> method is implemented.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Callback function called by SQLite.</span>
</span><span class='line'><span class="c1">// This function shows how native and managed objects can work together!</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">userData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">azColName</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">IntPtr</span> <span class="n">pointer</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
</span><span class='line'>    <span class="n">GCHandle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">GCHandle</span><span class="o">::</span><span class="n">FromIntPtr</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SQLiteDataCarrier</span><span class="o">^</span> <span class="n">carrier</span> <span class="o">=</span> <span class="p">(</span><span class="n">SQLiteDataCarrier</span><span class="o">^</span><span class="p">)</span> <span class="n">handle</span><span class="p">.</span><span class="n">Target</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">columnName</span> <span class="o">=</span> <span class="n">azColName</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">columnValue</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">carrier</span><span class="o">-&gt;</span><span class="n">ColumnNames</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="n">gcnew</span> <span class="n">String</span><span class="p">(</span><span class="n">columnName</span><span class="p">));</span>
</span><span class='line'>        <span class="n">carrier</span><span class="o">-&gt;</span><span class="n">ColumnValues</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="n">gcnew</span> <span class="n">String</span><span class="p">(</span><span class="n">columnValue</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">SQLite</span><span class="o">::</span><span class="n">Execute</span><span class="p">(</span><span class="n">String</span><span class="o">^</span> <span class="n">sql</span><span class="p">,</span> <span class="n">Action</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^&gt;^</span> <span class="n">callback</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">IntPtr</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Marshal</span><span class="o">::</span><span class="n">StringToHGlobalAnsi</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_sql</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">ToPointer</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Output will be stored in these lists</span>
</span><span class='line'>    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnNames</span> <span class="o">=</span> <span class="n">gcnew</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;</span><span class="p">();</span>
</span><span class='line'>    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnValues</span> <span class="o">=</span> <span class="n">gcnew</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// A simple class to aggregate columnNames and columnValues so that it can be passed to SQLite and SQLite will give it back in the callback function</span>
</span><span class='line'>    <span class="n">SQLiteDataCarrier</span><span class="o">^</span> <span class="n">carrier</span> <span class="o">=</span> <span class="n">gcnew</span> <span class="n">SQLiteDataCarrier</span><span class="p">(</span><span class="n">columnNames</span><span class="p">,</span> <span class="n">columnValues</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Converting carrier to void*</span>
</span><span class='line'>    <span class="n">GCHandle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">GCHandle</span><span class="o">::</span><span class="n">Alloc</span><span class="p">(</span><span class="n">carrier</span><span class="p">);</span>
</span><span class='line'>    <span class="n">IntPtr</span> <span class="n">pointer</span> <span class="o">=</span> <span class="n">GCHandle</span><span class="o">::</span><span class="n">ToIntPtr</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">zErrMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">_sql</span><span class="p">,</span> <span class="n">_callback</span><span class="p">,</span> <span class="n">pointer</span><span class="p">.</span><span class="n">ToPointer</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">zErrMsg</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">String</span><span class="o">^</span> <span class="n">message</span> <span class="o">=</span> <span class="n">gcnew</span> <span class="n">String</span><span class="p">(</span><span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">db</span><span class="p">));</span>
</span><span class='line'>        <span class="k">throw</span> <span class="n">gcnew</span> <span class="n">SQLiteError</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">callback</span><span class="o">-&gt;</span><span class="n">Invoke</span><span class="p">(</span><span class="n">columnNames</span><span class="p">,</span> <span class="n">columnValues</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">handle</span><span class="p">.</span><span class="n">Free</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Marshal</span><span class="o">::</span><span class="n">FreeHGlobal</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To add results into the list, we are passing both lists to the <code>sqlite3_exec()</code> function so that SQLite will pass that back to the <code>_callback</code> function. This is very powerful because we just passed a managed object into a native function call. Then in a native function, we obtained the managed instance and modified properties on it.</p>

<p>Once the querying is done, database has to be closed. We do that in the destructor.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// In C++/CLI destructor will be implemented using Dispose() pattern</span>
</span><span class='line'><span class="n">SQLite</span><span class="o">::~</span><span class="n">SQLite</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Using from C#</h2>

<p>Usage from C# now becomes pretty straightforward.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">ConsoleApplication1</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Program</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">SQLite</span> <span class="n">db</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SQLite</span><span class="p">(</span><span class="s">&quot;C:\\Users\\navaneeth\\Desktop\\test\\example.db&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="kt">string</span> <span class="n">sql</span> <span class="p">=</span> <span class="s">&quot;create table if not exists foos (name text);\n&quot;</span> <span class="p">+</span>
</span><span class='line'>                <span class="s">&quot;insert into foos values (&#39;sample1&#39;);&quot;</span> <span class="p">+</span>
</span><span class='line'>                <span class="s">&quot;insert into foos values (&#39;sample2&#39;);&quot;</span> <span class="p">+</span>
</span><span class='line'>                <span class="s">&quot;select * from foos;&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="n">db</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">columnNames</span><span class="p">,</span> <span class="n">columnValues</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">name</span> <span class="k">in</span> <span class="n">columnNames</span><span class="p">)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="k">value</span> <span class="k">in</span> <span class="n">columnValues</span><span class="p">)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>            <span class="n">db</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">Read</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can download the code <a href="https://dl.dropbox.com/u/52296034/blog/SQLiteWrapper.zip">here</a>. Happy programming!</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name"><a href="/blog/2013/02/08/funny-gtk-warning/" itemprop="url">Funny GTK Warning</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I was working with a GTK application and got the below warning.</p>

<blockquote><p> Trying to remove a child that doesn&rsquo;t believe we&rsquo;re it&rsquo;s parent</p></blockquote>

<p>:)</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name"><a href="/blog/2012/05/11/simple-generic-and-dynamically-allocated-array-in-c/" itemprop="url">Simple, Generic and Dynamically Allocated Array in C</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>C is a very good language. I have been using for quite some time for my opensource project. The flexibility C offers is really good. But sometimes, lack of simple datastructures like a dynamically growing array will slow down the programmer. There are tons of implementation available online, but most of them are overcomplicated, got lot of dependencies or tough to understand and incorporate with your application. In this post, I present a simple array which grows dynamically, reuses the memory, supports any pointer type and easy to copy to your code base.</p>

<p>Here is the code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">varray_t</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">void</span> <span class="o">**</span><span class="n">memory</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">size_t</span> <span class="n">allocated</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">size_t</span> <span class="n">used</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">varray</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">varray_init</span><span class="p">(</span><span class="n">varray</span> <span class="o">**</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="n">varray</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">varray</span><span class="p">));</span>
</span><span class='line'>   <span class="p">(</span><span class="o">*</span><span class="n">array</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>   <span class="p">(</span><span class="o">*</span><span class="n">array</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>   <span class="p">(</span><span class="o">*</span><span class="n">array</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>   <span class="p">(</span><span class="o">*</span><span class="n">array</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">varray_push</span><span class="p">(</span><span class="n">varray</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">size_t</span> <span class="n">toallocate</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'>   <span class="k">if</span> <span class="p">((</span><span class="n">array</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">-</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">toallocate</span> <span class="o">=</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="p">(</span><span class="n">array</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>      <span class="n">array</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">array</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span> <span class="n">toallocate</span><span class="p">);</span>
</span><span class='line'>      <span class="n">array</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">=</span> <span class="n">toallocate</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">array</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">[</span><span class="o">++</span><span class="n">array</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>   <span class="n">array</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">varray_length</span><span class="p">(</span><span class="n">varray</span> <span class="o">*</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">varray_clear</span><span class="p">(</span><span class="n">varray</span> <span class="o">*</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>   <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">varray_length</span><span class="p">(</span><span class="n">array</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">array</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="n">array</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>   <span class="n">array</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">varray_free</span><span class="p">(</span><span class="n">varray</span> <span class="o">*</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">);</span>
</span><span class='line'>   <span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span><span class="o">*</span>
</span><span class='line'><span class="nf">varray_get</span><span class="p">(</span><span class="n">varray</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">return</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">varray_insert</span><span class="p">(</span><span class="n">varray</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">array</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This array doesn’t take ownership of the data it contains. Ownership has to be managed separately. When adding a new item, array grows in constant propotion yielding inserts in amortized constant time. I have omitted error checking for malloc and realloc for simplicity.</p>

<p>Hope you enjoy the post.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name"><a href="/blog/2011/06/01/this-is-a-test/" itemprop="url">This Is Post</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Booyah!</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name"><a href="/blog/2010/12/19/simple-egg-timer-on-linux-for-pomodoro-technique/" itemprop="url">Simple Egg Timer on Linux for Pomodoro Technique</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Recently I have started evaluating the Pomodoro Technique which I found quite interesting. I am still evaluating the technique and not yet concluded on whether I should continue using it.</p>

<p>To implement pomodoro technique, you need a kitchen timer or egg timer. Since I use pomodoro for my programming work, I obviously don’t want to use a physical timer. I couldn’t find a decent timer for linux especially one that works well with Xfce. In this blog post, I will explain building a kitchen timer with basic linux programming techniques. This also gives an idea about how simple linux tools can be combined to do useful stuff.</p>

<p>Things that are used</p>

<ul>
<li>Shell scripting</li>
<li>Notification mechanisms on popular desktops like Gnome and Xfce. (I use Xfce in this example)</li>
</ul>


<p>The shell script is actually a modified version of the one published here (<a href="http://mostlylinux.wordpress.com/commandline/eggtimer/">http://mostlylinux.wordpress.com/commandline/eggtimer/</a>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nv">counter</span><span class="o">=</span>0
</span><span class='line'><span class="nv">limit</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">summary</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'><span class="nv">startmessage</span><span class="o">=</span><span class="nv">$3</span>
</span><span class='line'><span class="nv">endmessage</span><span class="o">=</span><span class="nv">$4</span>
</span><span class='line'>notify-send -u critical -i appointment -t 600 <span class="s2">&quot;$summary&quot;</span> <span class="s2">&quot;$startmessage&quot;</span>
</span><span class='line'><span class="nb">echo</span>
</span><span class='line'><span class="k">while</span> <span class="o">[</span> <span class="nv">$counter</span> !<span class="o">=</span> <span class="nv">$limit</span> <span class="o">]</span>; <span class="k">do</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;$counter minutes so far...&quot;</span>;
</span><span class='line'>   sleep 60
</span><span class='line'>   <span class="nb">let</span> <span class="s2">&quot;counter = $counter + 1&quot;</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$counter</span> <span class="o">=</span> <span class="nv">$limit</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span>
</span><span class='line'><span class="nb">   </span>notify-send -u critical -i appointment <span class="s2">&quot;$summary&quot;</span> <span class="s2">&quot;$endmessage&quot;</span>
</span><span class='line'>   <span class="nb">echo</span> -e <span class="s1">&#39;\a&#39;</span> &amp;gt;&amp;amp;2
</span><span class='line'>   <span class="nb">exit </span>0
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>All it does is wait until the limit reaches. It uses the sleep(1) command to sleep for a minute. notify-send is used for sending notifications to the desktop environment.</p>

<p>This script can be invoked using,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>./p-timer.sh
</span></code></pre></td></tr></table></div></figure>


<p>If you use bash, you can add an alias for convenience.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">alias </span>begin-pomodoro<span class="o">=</span><span class="s1">&#39;sh ~/utils/p-timer.sh 25 &quot;Pomodoro&quot; &quot;Pomodoro started, you have 25 minutes left&quot; &quot;Pomodoro ended. Please stop the work and take short break&quot;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This post is written on one pomodoro!</p>

<p>Happy programming!</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name"><a href="/blog/2009/09/15/disabling-a-custom-control-from-visual-studios-toolbox/" itemprop="url">Disabling a Custom Control From Visual Studio’s Toolbox</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>When a custom control is created, Visual Studio will show it in the toolbox for dragging and dropping. This can be annoying when you create a composite control which is a combination of several other custom controls where VS will display all custom controls in the toolbox. <code>System.ComponentModel.ToolBoxItemAttribute</code> can be used with the controls that you want to hide from toolbox. Apply this attribute to all the controls that you want to hide from toolbox.</p>

<p>Sample code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[System.ComponentModel.ToolboxItem(false)]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">MyCustomControl</span> <span class="p">:</span> <span class="n">Label</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>MyCustomControl</code> will not be displayed on the toolbox.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name"><a href="/blog/2009/08/18/circular-linked-list-an-implementation-using-c-number/" itemprop="url">Circular Linked List – an Implementation Using C#</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In this post, I will explain about creating a circular doubly linked list using C#. .NET framework provides a doubly linked list implementation in System.Collections.Generic.LinkedList<T> class . But this class is not providing the behavior of a circular linked list and it is very tough to extend for supporting circular linked list requirements.</p>

<p>In a normal doubly linked list, each node will have a link to its previous and next nodes. In a circular doubly linked list, tail node’s next node will be head and head node’s previous node will be tail. Here is an image taken from wikipedia which visualizes circular linked list.</p>

<p><img src="images/posts/circular_linked_list.png" title="Circular linked list" alt="Alt text" /></p>

<p> Here is our requirements for the circular linked list</p>

<ul>
<li>Adding items to the list should be O(1).</li>
<li>Provide similar interface like the standard LinkedList<T> class.</li>
<li>Keep items in a type-safe way.</li>
<li>Avoid using collections like List or array internally for keeping items.</li>
<li>Should provide access to Head and Tail</li>
<li>Option to enumerate all items</li>
<li>Reverse enumeration</li>
<li>Access items with an index.</li>
<li>Maintain collection semantics.</li>
</ul>


<p>Here is the class diagram.</p>

<p><img src="images/posts/classdiagram1.png" title="Class diagram" alt="Alt text" /></p>

<h2>Node&lt;T&gt; class</h2>

<blockquote><p>Every problem can be solved by adding another layer of indirection.</p></blockquote>

<p>Node class is a layer of indirection added to hold the linked list value. It manages the next and previous items and provides an option to get the current value. This class is immutable. Here is Node class looks like,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'><span class="c1">/// Represents a node</span>
</span><span class='line'><span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'><span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;</span>
</span><span class='line'><span class="na">[DebuggerDisplay(&quot;Value = {Value}&quot;)]</span>
</span><span class='line'><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>    <span class="c1">/// Gets the Value</span>
</span><span class='line'>    <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">T</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>    <span class="c1">/// Gets next node</span>
</span><span class='line'>    <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Next</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">internal</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>    <span class="c1">/// Gets previous node</span>
</span><span class='line'>    <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Previous</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">internal</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>    <span class="c1">/// Initializes a new &lt;see cref=&quot;Node&quot;/&gt; instance</span>
</span><span class='line'>    <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>    <span class="c1">/// &lt;param name=&quot;item&quot;&gt;Value to be assigned&lt;/param&gt;</span>
</span><span class='line'>    <span class="k">internal</span> <span class="nf">Node</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">item</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>CircularLinkedList&lt;T&gt; class</h2>

<p>Keeping the requirements in mind, let us start writing the generic CircularLinkedList<T>. Some linked list implementations maintains only a link to the head node and when adding a new item to the list, each node in the list has to be traveled till tail node is found and this gives O(n) complexity for the algorithm.</p>

<p>Maintaining link to head and tail helps us to do insertions with a O(1) complexity. In such cases, list traversal is not required. All we need is to change the pointer in the tail node. Head and tail node are member variables of CircularLinkedList class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">CircularLinkedList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [DebuggerBrowsable(DebuggerBrowsableState.Never)]</span>
</span><span class='line'>    <span class="n">Node</span> <span class="n">head</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [DebuggerBrowsable(DebuggerBrowsableState.Never)]</span>
</span><span class='line'>    <span class="n">Node</span> <span class="n">tail</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To add an item to the last, we need to create a new node from the supplied item. Set the new node’s next pointer pointing to the list’s head and previous pointing to the tail. Finally, tail will be replaced with the new node. Here is the <code>AddLast()</code> method implementation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">AddLast</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// if head is null, then this will be the first item</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">AddFirstItem</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">newNode</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">item</span><span class="p">);</span>
</span><span class='line'>        <span class="n">tail</span><span class="p">.</span><span class="n">Next</span> <span class="p">=</span> <span class="n">newNode</span><span class="p">;</span>
</span><span class='line'>        <span class="n">newNode</span><span class="p">.</span><span class="n">Next</span> <span class="p">=</span> <span class="n">head</span><span class="p">;</span>
</span><span class='line'>        <span class="n">newNode</span><span class="p">.</span><span class="n">Previous</span> <span class="p">=</span> <span class="n">tail</span><span class="p">;</span>
</span><span class='line'>        <span class="n">tail</span> <span class="p">=</span> <span class="n">newNode</span><span class="p">;</span>
</span><span class='line'>        <span class="n">head</span><span class="p">.</span><span class="n">Previous</span> <span class="p">=</span> <span class="n">tail</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">++</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">void</span> <span class="nf">AddFirstItem</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">head</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">item</span><span class="p">);</span>
</span><span class='line'>    <span class="n">tail</span> <span class="p">=</span> <span class="n">head</span><span class="p">;</span>
</span><span class='line'>    <span class="n">head</span><span class="p">.</span><span class="n">Next</span> <span class="p">=</span> <span class="n">tail</span><span class="p">;</span>
</span><span class='line'>    <span class="n">head</span><span class="p">.</span><span class="n">Previous</span> <span class="p">=</span> <span class="n">tail</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can easily add another method that will add item to the first position in the list. Implementation looks similar like <code>AddLast()</code>. Unlike <code>AddLast()</code>, head node’s previous pointer will be re-pointed to the new node. The new node’s previous and next pointer will be pointed to tail and head respectively. Finally head will be replaced with the new node.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">AddFirst</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">AddFirstItem</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">newNode</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">item</span><span class="p">);</span>
</span><span class='line'>        <span class="n">head</span><span class="p">.</span><span class="n">Previous</span> <span class="p">=</span> <span class="n">newNode</span><span class="p">;</span>
</span><span class='line'>        <span class="n">newNode</span><span class="p">.</span><span class="n">Previous</span> <span class="p">=</span> <span class="n">tail</span><span class="p">;</span>
</span><span class='line'>        <span class="n">newNode</span><span class="p">.</span><span class="n">Next</span> <span class="p">=</span> <span class="n">head</span><span class="p">;</span>
</span><span class='line'>        <span class="n">tail</span><span class="p">.</span><span class="n">Next</span> <span class="p">=</span> <span class="n">newNode</span><span class="p">;</span>
</span><span class='line'>        <span class="n">head</span> <span class="p">=</span> <span class="n">newNode</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">++</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finding an item from the list will have a <code>O(n)</code> complexity as it needs to traverse through all items in the list until we get a matching item. Here is a recursive implementation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Find</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">node</span> <span class="p">=</span> <span class="n">FindNode</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">item</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">node</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">FindNode</span><span class="p">(</span><span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">node</span><span class="p">,</span> <span class="n">T</span> <span class="n">valueToCompare</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">comparer</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">valueToCompare</span><span class="p">))</span>
</span><span class='line'>        <span class="n">result</span> <span class="p">=</span> <span class="n">node</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">==</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">Next</span> <span class="p">!=</span> <span class="n">head</span><span class="p">)</span>
</span><span class='line'>        <span class="n">result</span> <span class="p">=</span> <span class="n">FindNode</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">Next</span><span class="p">,</span> <span class="n">valueToCompare</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Providing an iterator to iterate the items in the list will be useful. Since this is a circular linked list, a reverse iterator also makes sense. <code>yield</code> keyword makes iterator implementations almost trivial.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetEnumerator</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">current</span> <span class="p">=</span> <span class="n">head</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">do</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">yield</span> <span class="k">return</span> <span class="n">current</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Next</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">current</span> <span class="p">!=</span> <span class="n">head</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetReverseEnumerator</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">current</span> <span class="p">=</span> <span class="n">tail</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">do</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">yield</span> <span class="k">return</span> <span class="n">current</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Previous</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">current</span> <span class="p">!=</span> <span class="n">tail</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Removing items from list is also just re-pointing the previous and next pointers of the node’s previous.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="kt">bool</span> <span class="nf">Remove</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// finding the first occurance of this item</span>
</span><span class='line'>    <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">nodeToRemove</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">nodeToRemove</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">nodeToRemove</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">bool</span> <span class="nf">RemoveNode</span><span class="p">(</span><span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">nodeToRemove</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">previous</span> <span class="p">=</span> <span class="n">nodeToRemove</span><span class="p">.</span><span class="n">Previous</span><span class="p">;</span>
</span><span class='line'>    <span class="n">previous</span><span class="p">.</span><span class="n">Next</span> <span class="p">=</span> <span class="n">nodeToRemove</span><span class="p">.</span><span class="n">Next</span><span class="p">;</span>
</span><span class='line'>    <span class="n">nodeToRemove</span><span class="p">.</span><span class="n">Next</span><span class="p">.</span><span class="n">Previous</span> <span class="p">=</span> <span class="n">nodeToRemove</span><span class="p">.</span><span class="n">Previous</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// if this is head, we need to update the head reference</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="p">==</span> <span class="n">nodeToRemove</span><span class="p">)</span>
</span><span class='line'>        <span class="n">head</span> <span class="p">=</span> <span class="n">nodeToRemove</span><span class="p">.</span><span class="n">Next</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">tail</span> <span class="p">==</span> <span class="n">nodeToRemove</span><span class="p">)</span>
</span><span class='line'>        <span class="n">tail</span> <span class="p">=</span> <span class="n">tail</span><span class="p">.</span><span class="n">Previous</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">--</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, an indexer is provided so that list items can be accessed using an index. Like <code>Find()</code> method, this also has a <code>O(n)</code> complexity.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">get</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&gt;=</span> <span class="n">count</span> <span class="p">||</span> <span class="n">index</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="s">&quot;index&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Node</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">node</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span><span class='line'>                <span class="n">node</span> <span class="p">=</span> <span class="n">node</span><span class="p">.</span><span class="n">Next</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">node</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To get a collection semantics and maintain similar interface like the standard LinkedList, we implement <code>ICollection&lt;T&gt;</code> and <code>IEnumerable&lt;T&gt;</code> interfaces.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">CircularLinkedList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// code</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Test harness</h2>

<p>Following code shows how this class can be used,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CircularLinkedList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CircularLinkedList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="n">list</span><span class="p">.</span><span class="n">AddLast</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">list</span><span class="p">.</span><span class="n">AddLast</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
</span><span class='line'>    <span class="n">list</span><span class="p">.</span><span class="n">AddLast</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;List count = {0}&quot;</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Head  = {0}&quot;</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">Head</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Tail  = {0}&quot;</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">Tail</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Head&#39;s Previous  = {0}&quot;</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">Head</span><span class="p">.</span><span class="n">Previous</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Tail&#39;s Next  = {0}&quot;</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">Tail</span><span class="p">.</span><span class="n">Next</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;************List Items***********&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;************List Items in reverse***********&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">IEnumerator</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">r</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">GetReverseEnumerator</span><span class="p">();</span> <span class="n">r</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">();</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;************Adding a new item at first***********&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">list</span><span class="p">.</span><span class="n">AddFirst</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;************Adding item before***********&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">list</span><span class="p">.</span><span class="n">AddBefore</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">11</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;************Adding item after***********&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">list</span><span class="p">.</span><span class="n">AddAfter</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Possible expansions</h2>

<p>There are good and complex features that can be added to this list. Here are few that will be useful,</p>

<ul>
<li>Remove duplicate nodes.</li>
<li>Move nodes around.</li>
<li>Sorting.</li>
</ul>


<p>Probably we will see these features in another post.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name"><a href="/blog/2009/08/13/what-great-net-developers-ought-to-know-net-interview-questions-and-answers-part1/" itemprop="url">What Great .NET Developers Ought to Know (More .NET Interview Questions and Answers) – Part1</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In this series of posts, I will try to answer the questions posted by Scott Hanselman <a href="http://www.hanselman.com/blog/WhatGreatNETDevelopersOughtToKnowMoreNETInterviewQuestions.aspx">here</a>. This part we will be seeing the first set of questions he has given under <em>Everyone who writes code</em> heading.</p>

<p><strong>Q) Describe the difference between a Thread and a Process?</strong></p>

<p>A Thread is a small unit of code in execution. A process is an instance of program which will have multiple threads running. A process can host multiple threads. Thread will always belong to a process. Communication between multiple processes are difficult but communication between threads is easy.</p>

<p><strong>Q) What is a Windows Service and how does its lifecycle differ from a “standard” EXE?</strong></p>

<p>Windows service is a long running program which can run without user interaction. It is used for applications that should work always, e.g: a HTTP server. Unlike standard EXE, a windows service can’t be started by double clicking the EXE. It should be installed on the system as a service using installutil tool. Service control manager manges a windows service by providing options to start/stop a service.</p>

<p>Like a standard EXE, windows services lifecycle also begins from the main method. After that it fires the event OnStart in which you can write code for starting a service.</p>

<p><strong>Q) What is the difference between an EXE and a DLL?</strong></p>

<p>A executable file(EXE) is ready to execute wherein a Dynamic Link Library(DLL) contains types and methods that can be used from a EXE. DLLs are not meant to be executed directly and it is very helpful to organize and isolate common code which can be used with multiple applications.</p>

<p>Finally, EXE will have an entry point. DLLs will not have an entry point and all it does is to expose the types and methods. The direct equivalent of a DLL in LINUX is Shared Libraries(SO).</p>

<p><strong>Q) What is strong-typing versus weak-typing? Which is preferred? Why?</strong></p>

<p>Strong-typing defines some restrictions on how operations are done when different data types are involved. Consider the following example</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">int</span> <span class="n">a</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
</span><span class='line'><span class="n">a</span> <span class="p">=</span> <span class="s">&quot;You can&#39;t assign a string!&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Above code won’t compile as variable a is strongly-typed and it can hold only an integer value.</p>

<p>Weak-typing is just opposite of strong-typing. C# is a strongly-typed language. But since most of the types derives from System.Object, you can write like.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">object</span> <span class="n">o</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This can be called as weak-typing. Of course, strong-typing is preferred over weak-typing. To understand why, consider the following example in which we have a collection of age.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ArrayList</span> <span class="n">ages</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="p">();</span>
</span><span class='line'><span class="n">ages</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span><span class='line'><span class="n">ages</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">20</span><span class="p">);</span>
</span><span class='line'><span class="n">ages</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">30</span><span class="p">);</span>
</span><span class='line'><span class="n">ages</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;Hey, I am not an age!&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our intention is to have only ages in this collection. But since ArrayList is weakly-typed, we inserted a value which is not an age. Here is a strongly-types version of this code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">ages</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>
</span><span class='line'><span class="n">ages</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span><span class='line'><span class="n">ages</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">20</span><span class="p">);</span>
</span><span class='line'><span class="n">ages</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">30</span><span class="p">);</span>
</span><span class='line'><span class="n">ages</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;I am not an age&quot;</span><span class="p">);</span> <span class="c1">// &lt;- compiler error here</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Q) What is a PID? How is it useful when troubleshooting a system?</strong></p>

<p>PID is Process Identifier and used by operating system to identify processes uniquely. I am not sure how it is used for troubleshooting. If some can provide insights into this, I will update this area.</p>

<p><strong>Q) How many processes can listen on a single TCP/IP port?</strong></p>

<p>Only one.</p>

<p><strong>Q) What is the GAC? What problem does it solve?</strong></p>

<p>GAC stands for Global Assembly Cache. It provides a centralized storage for assemblies that needs to be shared across applications. It solved the versioning problem and allows side-by-side execution. It can be used when assemblies require elevated permission to do the job.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name"><a href="/blog/2009/07/11/ado-dot-net-best-practices-reading-data-from-data-reader/" itemprop="url">ADO.NET Best Practices – Reading Data From Data Reader</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I have seen many people using DataReader incorrectly. In this post, I will try to explain some good practices that can be followed when reading from a data reader. Consider the following problematic code,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SqlDataReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="cm">/* ... */</span><span class="p">;</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">userName</span> <span class="p">=</span> <span class="n">reader</span><span class="p">[</span><span class="s">&quot;user_name&quot;</span><span class="p">].</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">age</span> <span class="p">=</span> <span class="kt">int</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span> <span class="n">reader</span><span class="p">[</span><span class="s">&quot;age&quot;</span><span class="p">].</span><span class="n">ToString</span><span class="p">()</span> <span class="p">);</span>
</span><span class='line'>    <span class="cm">/* ... */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">reader</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>How many problems can you figure out from the above code? There are many problems with this code,</p>

<ul>
<li>The columns “user_name” and “age” may or may not exist. If the column does not exist in the reader, it will throw error.</li>
<li>You may be calling <code>ToString()</code> on an object which may be pointing to <code>NULL</code>. This will lead to a null reference exception.</li>
<li><code>SqlDataReader</code> implements <code>IDisposable</code> and user code has to call <code>Dispose()</code> each time to release the resources deterministically. This is not happening here.</li>
<li><code>reader["age"]</code> may contain values that are not compatible with integer. In such case, <code>int.Parse()</code> will throw a <code>FormatException</code>.</li>
</ul>


<p>Following sections will show a safe method to read data from DataReader.</p>

<h2>Understanding ordinals</h2>

<p>Ordinal is the index of a column in the reader. <code>GetOrdinal()</code> method will give you the ordinal for the column name supplied. So the first step in reading data from reader should be to find the ordinal of the columns which we want to read. Before getting the ordinal values, you have to ensure that the reader can read. SqlDataReader provides a HasRows property which can be useful here. Here is how you read the ordinals</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SqlDataReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="cm">/* ... */</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">userNameOrdinal</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">ageOrdinal</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">HasRows</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">try</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>           <span class="n">userNameOrdinal</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetOrdinal</span><span class="p">(</span><span class="s">&quot;user_name&quot;</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>     <span class="k">catch</span> <span class="p">(</span><span class="n">IndexOutOfRangeException</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>           <span class="k">throw</span> <span class="k">new</span> <span class="nf">YourCustomException</span><span class="p">(</span><span class="s">&quot;Expected column &#39;user_name&#39; not found&quot;</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>     <span class="k">try</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>           <span class="n">ageOrdinal</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetOrdinal</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>     <span class="k">catch</span> <span class="p">(</span><span class="n">IndexOutOfRangeException</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>           <span class="k">throw</span> <span class="k">new</span> <span class="nf">YourCustomException</span><span class="p">(</span><span class="s">&quot;Expected column &#39;age&#39; not found&quot;</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you have support to “Extension methods”, this code can be simplified further.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">SqlDataReaderExtensions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">GetOrdinalOrThrow</span><span class="p">(</span><span class="k">this</span> <span class="n">SqlDataReader</span> <span class="n">reader</span><span class="p">,</span> <span class="kt">string</span> <span class="n">columnName</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetOrdinal</span><span class="p">(</span><span class="n">columnName</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">catch</span> <span class="p">(</span><span class="n">IndexOutOfRangeException</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">YourCustomException</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Expected column &#39;{0}&#39; not found&quot;</span><span class="p">,</span><span class="n">columnName</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">SqlDataReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="cm">/* ... */</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">userNameOrdinal</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">ageOrdinal</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">HasRows</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>      <span class="n">userNameOrdinal</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetOrdinalOrThrow</span><span class="p">(</span><span class="s">&quot;user_name&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">ageOrdinal</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetOrdinalOrThrow</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This makes the code more clean. However, I really wish to see a <code>TryGetOrdinal()</code> method on <code>IDataReader</code> so that we can save the cost of exception handling.</p>

<p>GetOrdinal() method first does a case-sensitive lookup for the column name. If it fails, case-insensitive search is performed. Thus, using the column name in correct case with GetOrdinal() will be more efficient.</p>

<h2>Respecting type safety</h2>

<p>C# is a strongly typed language and each programmer should take full advantage of this. Reading data like, <code>reader["user_name"]</code> is not a type safe way as it returns a object. Data reader provides methods to read data in a type safe way.</p>

<p>Here is what MSDN says about it</p>

<blockquote><pre><code>When accessing column data use the typed accessors like GetString, GetInt32, and so on. This saves you the processing required to cast the Object returned from GetValue as a particular type. 
</code></pre></blockquote>

<p>Now let us follow the above suggestion and rewrite our code like,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">while</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">string</span> <span class="n">userName</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">userNameOrdinal</span><span class="p">);</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">age</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span><span class='line'>   <span class="k">try</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>         <span class="n">age</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetInt32</span><span class="p">(</span><span class="n">ageOrdinal</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidCastException</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>         <span class="k">throw</span> <span class="k">new</span> <span class="nf">YourCustomException</span><span class="p">(</span><span class="s">&quot;Unable to read age. Expecting integer value&quot;</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Releasing resources</h2>

<p>If any type implements IDisposable, it is like saying “I have something to release explicitly rather than garbage collector to release it“. So it is programmers duty to ensure the calls to Dispose() when using disposable types. C# has “using” statement (stack semantics can be used in C++/CLI) which will ensure calls to Dispose(). Since DataReader is a disposable object, we can write like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">using</span><span class="p">(</span><span class="n">SqlDataReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">command</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>      <span class="k">while</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">())</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">userName</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">userNameOrdinal</span><span class="p">);</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">age</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span><span class='line'>          <span class="k">try</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">age</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetInt32</span><span class="p">(</span><span class="n">ageOrdinal</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidCastException</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">throw</span> <span class="k">new</span> <span class="nf">YourCustomException</span><span class="p">(</span><span class="s">&quot;Unable to read age. Expecting integer value&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="cm">/* ... */</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This ensures that the reader is disposed properly even in exceptional situations.</p>

<h2>Putting everything together</h2>

<p>If you put everything together, code will be like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">SqlDataReaderExtensions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">GetOrdinalOrThrow</span><span class="p">(</span><span class="k">this</span> <span class="n">SqlDataReader</span> <span class="n">reader</span><span class="p">,</span> <span class="kt">string</span> <span class="n">columnName</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetOrdinal</span><span class="p">(</span><span class="n">columnName</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">catch</span> <span class="p">(</span><span class="n">IndexOutOfRangeException</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">YourCustomException</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Expected column &#39;{0}&#39; not found&quot;</span><span class="p">,</span><span class="n">columnName</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">userNameOrdinal</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">ageOrdinal</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">HasRows</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">userNameOrdinal</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetOrdinalOrThrow</span><span class="p">(</span><span class="s">&quot;user_name&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">ageOrdinal</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetOrdinalOrThrow</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">using</span> <span class="p">(</span><span class="n">SqlDataReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">GetReader</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">())</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">string</span> <span class="n">userName</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">userNameOrdinal</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">age</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">age</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetInt32</span><span class="p">(</span><span class="n">ageOrdinal</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidCastException</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">YourCustomException</span><span class="p">(</span><span class="s">&quot;Unable to read age. Expecting integer value&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="cm">/* ... */</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have got clean code now. It handles the exceptions and throws informative exceptions to the caller rather than throwing Boneheaded exceptions, we have avoided explicit casting and DataReader is disposed properly.</p>

<p>These are applicable for all types which implements <code>IDataReader</code>. <code>SqlDataReader</code> is used in this post just for explanation.</p>

<p>Happy programming!</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
        <a href="/" class="prev">Prev</a>
    
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2014 - nkn -
  <span class="credit"><a href="http://octopress.org">Octopress</a></span>
</p>


<p>Theme: <a href="https://github.com/qingwang/octopress-theme-yinyang">YinYang</a></p>
</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'lovetocode';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-38544003-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



		</div>
	</div>
</body>
</html>
